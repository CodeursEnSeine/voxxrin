<!doctype html>
<html>
  <head>
      <script type="text/javascript" src="assets/js/libs/underscore-min.js"></script>
      <script type="text/javascript" src="assets/js/libs/knockout-2.0.0.js"></script>
      <script type="text/javascript" src="assets/js/libs/date.format.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery-1.7.1.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.atmosphere.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.form.js"></script>
      <script type="text/javascript" src="assets/js/libs/processing-1.3.6.js"></script>
      <script type="text/javascript" src="assets/js/voxxr-utils.js"></script>
      <script type="text/javascript" src="assets/js/models-ds.js"></script>
      <script type="text/javascript" src="assets/js/models-EV.js"></script>
      <script type="text/javascript" src="assets/js/models-user.js"></script>
      <script type="text/javascript" src="assets/js/models-room.js"></script>
      <script type="text/javascript" src="assets/js/models-speaker.js"></script>
      <script type="text/javascript" src="assets/js/models-presentation.js"></script>
      <script type="text/javascript">
          $(function() {
              function withPrez(prez) {
                  prez = new models.Presentation(prez);
                  prez.playing(true);
                  models.Room.current(prez.room());
                  prez.room().currentPresentation(prez);
                  prez.room().connect();
                  models.Room.onEV(function(ev) {
                      console.log('EV', ev);
                      if (ev.isRate) {
                          var rateDrops = Processing.getInstanceById("rateDrops");
                          rateDrops.setPalette({1:0xffC44D58, 2:0xffFF6B6B, 3:0xffFBD405, 4:0xff4ECDC4, 5:0xffC7F464});
                          if(rateDrops != null) { rateDrops.addEvenire(ev); }
                      }
                      if (ev.isFeeling) {
                          var feelingDrops = Processing.getInstanceById("feelingDrops");
                          feelingDrops.setPalette({1:0xffc7f464, 2:0xffc44d58, 3:0xff4ecdc4})
                          if(feelingDrops != null) { feelingDrops.addEvenire(ev); }
                      }
                  });

                  var voxxr = { prez: prez, room: prez.room(), connections: ko.observable(0)};
                  ko.applyBindings(voxxr);

                  $("#start").click(function() { models.Room.current().sendEV('PZS')});
                  $("#stop").click(function() { models.Room.current().sendEV('PZE')});
              }


              if (!urlParams['prez'] || !urlParams['event']) {
                  alert('you must give a presentation id as query param');
              } else {
                  var prezId = urlParams['prez'],
                      eventId = urlParams['event'];

                  models.baseUrl = "http://localhost:8080/r";
//    models.baseUrl = "http://2.latest.voxxr-web.appspot.com/r";
//    models.baseUrl = "http://voxxr-web.appspot.com/r";

                  $.ajax({
                        url: models.baseUrl + "/events/" + eventId + "/nowplaying",
                        dataType:"json",
                        success: function(data) {
                            var prez = _(data).find(function(p) {return p.id == prezId});
                            if (!prez) {
                                alert('presentation is not playing now');
                            } else {
                                withPrez(prez);
                            }
                        }
                  });
              }
          });
      </script>
      <style type="text/css">
      #rateDrops, #feelingDrops { width: 240px; height: 90px; }
      #conAndMean, #time {  width: 240px; height: 52px; margin: 5px 0; text-align: center; font-size: 32px; color: #4ecdc4; }
      #buttons {  width: 240px; text-align: center; margin: 5px 0; }
      #conAndMean .connections, #conAndMean .rateMean { font-size: 44px; color: #c7f464; }
      </style>
</head>
<body>
<div id="dashboard">
    <div id="conAndMean" data-bind="with: room">
        C <span class="connections" data-bind="text: connections">###</span>
        -
        R <span class="rateMean" data-bind="text: currentPresentation().rate.avgDisplay">#.##</span>
    </div>
    <canvas id="rateDrops"  data-processing-sources="assets/pde/EV-drops.pde"></canvas>
    <canvas id="feelingDrops"  data-processing-sources="assets/pde/EV-drops.pde"></canvas>
    <div id="time" data-bind="text: prez.time"></div>
    <div id="buttons" data-bind="with: prez">
        <button id="start" type="button" data-bind="visible: state() === 'STOPPED'">Start Presentation</button>
        <button id="stop" type="button" data-bind="visible: state() === 'STARTED'">Stop Presentation</button>
    </div>
</div>
</body>
</html>