<!doctype html>
<html>
  <head>
      <script type="text/javascript" src="assets/js/libs/jquery-1.7.1.js"></script>
      <script type="text/javascript" src="assets/js/libs/underscore-min.js"></script>
      <script type="text/javascript" src="assets/js/libs/knockout-2.0.0.debug.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.atmosphere.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.form.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.sparkline.min.js"></script>
      <script type="text/javascript" src="assets/js/libs/gfx.js"></script>
      <script type="text/javascript" src="assets/js/libs/gfx.effects.js"></script>
      <script type="text/javascript" src="assets/js/libs/gfx.flip.js"></script>

      <script type="text/javascript" src="assets/js/libs/date.format.js"></script>
      <script type="text/javascript" src="assets/js/libs/processing-1.3.6.js"></script>

      <script type="text/javascript" src="assets/js/voxxr-utils.js"></script>
      <script type="text/javascript" src="assets/js/voxxr-conf.js"></script>
      <script type="text/javascript" src="assets/js/models-ds.js"></script>
      <script type="text/javascript" src="assets/js/models-device.js"></script>
      <script type="text/javascript" src="assets/js/models-EV.js"></script>
      <script type="text/javascript" src="assets/js/models-user.js"></script>
      <script type="text/javascript" src="assets/js/models-room.js"></script>
      <script type="text/javascript" src="assets/js/models-speaker.js"></script>
      <script type="text/javascript" src="assets/js/models-presentation.js"></script>

      <script type="text/javascript">
          var pollStartedAt,
                  pollDuration = 30 * 1000;

          // functions called by poll.pde
          function getElapsedPercent() {
              return pollStartedAt ? Math.min(((Date.now() - pollStartedAt) * 100 / pollDuration)) : 100;
          }
          function onPollChoiceSelect(selected) {
              console.log('selected', selected);
              if (window.parent) {
                  window.parent.postMessage('pollresult:' + selected, '*');
              }
          }

          $(function() {
              var poll;

              function withPrez(prez) {
                  prez = ds.presentation(prez);
                  models.Room.bcmode = "DASHBOARD";
                  models.Room.current(prez.room());
                  models.Presentation.current(prez);
                  prez.room().presentation(prez);
                  prez.room().connect();
                  models.Room.onEV(function(ev) {
                      if (ev.isPollStart) {
                          poll = Processing.getInstanceById("poll");
                          poll.startPoll(prez.title(),"POLL",ev.items);
                          pollStartedAt = Date.now();
                          setTimeout(function() {models.Room.current().sendEV("PE");}, pollDuration);
                      }
                      if (ev.isPollVote) {
                          if (poll) poll.addPollVote(ev.vote);
                      }
                      if (ev.isPollEnd) {
                          if (poll) { pollStartedAt = null; poll.stopPoll(); }
                      }
                  });

                  var voxxr = { prez: prez, room: prez.room(), connections: ko.observable(0)};
                  ko.applyBindings(voxxr);
              }


              if (!urlParams['prez'] || !urlParams['event']) {
                  alert('you must give a presentation id as query param');
              } else {
                  var prezId = urlParams['prez'],
                      eventId = urlParams['event'];

                  $.ajax({
                        url: models.baseUrl + "/events/" + eventId + "/nowplaying",
                        dataType:"json",
                        success: function(data) {
                            var prez = _(data).find(function(p) {return p.id == prezId});
                            if (!prez) {
                                alert('presentation is not playing now');
                            } else {
                                withPrez(prez);
                            }
                        }
                  });
              }
//              $("#stress").click(function() {
//                  function stressOne() {
//                      var poll = Processing.getInstanceById("poll");
//                      if(poll != null) { poll.addPollVote(1); }
//                  }
//                  setInterval(stressOne, 1);
//              });
          });
      </script>
      <style type="text/css">
      #poll { width: 800px; height: 600px; }
      </style>
</head>
<body>
<div>
    <!--<input id="stress" type="button" value="STRESS">-->
    <canvas id="poll"  data-processing-sources="assets/pde/poll.pde"></canvas>
</div>
</body>
</html>