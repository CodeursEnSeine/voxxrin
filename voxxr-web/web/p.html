<!doctype html>
<html>
  <head>
      <script type="text/javascript" src="assets/js/libs/underscore-min.js"></script>
      <script type="text/javascript" src="assets/js/libs/knockout-2.0.0.js"></script>
      <script type="text/javascript" src="assets/js/libs/date.format.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery-1.7.1.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.atmosphere.js"></script>
      <script type="text/javascript" src="assets/js/libs/jquery.form.js"></script>
      <script type="text/javascript" src="assets/js/libs/processing-1.3.6.js"></script>
      <script type="text/javascript" src="assets/js/voxxr-utils.js"></script>
      <script type="text/javascript" src="assets/js/voxxr-conf.js"></script>
      <script type="text/javascript" src="assets/js/models-ds.js"></script>
      <script type="text/javascript" src="assets/js/models-device.js"></script>
      <script type="text/javascript" src="assets/js/models-EV.js"></script>
      <script type="text/javascript" src="assets/js/models-user.js"></script>
      <script type="text/javascript" src="assets/js/models-room.js"></script>
      <script type="text/javascript" src="assets/js/models-speaker.js"></script>
      <script type="text/javascript" src="assets/js/models-presentation.js"></script>

      <script type="text/javascript">
          function onPollChoiceSelect(selected) {
              console.log('selected', selected);
          }
          $(function() {
              function withPrez(prez) {
                  prez = new models.Presentation(prez);
                  prez.playing(true);
                  models.Room.bcmode = "DASHBOARD";
                  models.Room.current(prez.room());
                  models.Presentation.current(prez);
                  prez.room().connect();
                  models.Room.onEV(function(ev) {
                      console.log('EV', ev);
                      if (ev.isPollStart) {
                          var poll = Processing.getInstanceById("poll");
                          if(poll != null) { poll.startPoll(prez.title(),"POLL",30,ev.items); }
                      }
                      if (ev.isPollVote) {
                          var poll = Processing.getInstanceById("poll");
                          if(poll != null) { poll.addPollVote(ev.vote); }
                      }
                      if (ev.isPollEnd) {
                          var poll = Processing.getInstanceById("poll");
                          if(poll != null) { poll.stopPoll(); }
                      }
                  });

                  var voxxr = { prez: prez, room: prez.room(), connections: ko.observable(0)};
                  ko.applyBindings(voxxr);
              }


              if (!urlParams['prez'] || !urlParams['event']) {
                  alert('you must give a presentation id as query param');
              } else {
                  var prezId = urlParams['prez'],
                      eventId = urlParams['event'];

                  $.ajax({
                        url: models.baseUrl + "/events/" + eventId + "/nowplaying",
                        dataType:"json",
                        success: function(data) {
                            var prez = _(data).find(function(p) {return p.id == prezId});
                            if (!prez) {
                                alert('presentation is not playing now');
                            } else {
                                withPrez(prez);
                            }
                        }
                  });
              }
          });
      </script>
      <style type="text/css">
      #poll { width: 800px; height: 600px; }
      </style>
</head>
<body>
<div>
    <canvas id="poll"  data-processing-sources="assets/pde/poll.pde"></canvas>
</div>
</body>
</html>